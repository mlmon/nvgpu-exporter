name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  KO_DOCKER_REPO: ghcr.io/${{ github.repository }}
  COMMIT: ${{ github.sha }}

permissions:
  contents: write
  packages: write

jobs:
  release-containers:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            cc: gcc                 # native gcc is fine for amd64 on ubuntu-latest
            platform: linux/amd64
          - goos: linux
            goarch: arm64
            cc: aarch64-linux-gnu-gcc
            platform: linux/arm64

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache: true

    - name: Test
      run: go test ./...

    - name: Cache cross-compilation tools
      id: cache-compiler
      uses: actions/cache@v4
      with:
        path: |
          /usr/bin/aarch64-linux-gnu-*
          /usr/bin/x86_64-linux-gnu-*
          /usr/aarch64-linux-gnu
          /usr/x86_64-linux-gnu
          /usr/lib/gcc-cross/aarch64-linux-gnu
          /usr/lib/gcc-cross/x86_64-linux-gnu
          /usr/lib/aarch64-linux-gnu
          /usr/lib/x86_64-linux-gnu
          /usr/include/aarch64-linux-gnu
          /usr/include/x86_64-linux-gnu
          /lib/aarch64-linux-gnu
          /lib/x86_64-linux-gnu
        key: ${{ runner.os }}-cross-compile-${{ hashFiles('.github/workflows/release.yml') }}

    - name: Install cross compiler (if needed)
      if: matrix.cc == 'aarch64-linux-gnu-gcc' && steps.cache-compiler.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu

    - name: Set up ko
      uses: ko-build/setup-ko@v0.9

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract short SHA
      id: extract_sha
      run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Determine release metadata
      id: release_meta
      run: |
        ref="${GITHUB_REF}"
        short_sha="${{ steps.extract_sha.outputs.short_sha }}"
        include_latest="false"
        if [[ "$ref" == refs/tags/v* ]]; then
          tag="${ref#refs/tags/}"
          version="${tag#v}"
          include_latest="true"
        else
          tag="rel-${short_sha}"
          version="dev-${short_sha}"
        fi
        echo "tag=${tag}" >> $GITHUB_OUTPUT
        echo "version=${version}" >> $GITHUB_OUTPUT
        echo "include_latest=${include_latest}" >> $GITHUB_OUTPUT

    - name: Build and push with ko
      env:
        CGO_ENABLED: "1"
        CC: ${{ matrix.cc }}
        VERSION: ${{ steps.release_meta.outputs.version }}
        COMMIT: ${{ steps.extract_sha.outputs.short_sha }}
        INCLUDE_LATEST: ${{ steps.release_meta.outputs.include_latest }}
      run: |
        # Verify toolchain in logs
        $CC --version || true
        go env
        echo "Building for $GOOS/$GOARCH with CC=$CC"
        tags="${{ steps.release_meta.outputs.tag }},${{ steps.extract_sha.outputs.short_sha }}"
        if [[ "${INCLUDE_LATEST}" == "true" ]]; then
          tags="$tags,latest"
        fi
        ko build . \
          --platform=${{ matrix.platform }} \
          --base-import-paths \
          --tags=$tags \
          --image-label=org.opencontainers.image.source=https://github.com/${{ github.repository }} \
          --image-label=org.opencontainers.image.version=${{ steps.extract_version.outputs.version }} \
          --image-label=org.opencontainers.image.revision=${{ github.sha }}
